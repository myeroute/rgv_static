---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Sidebar from '../components/Sidebar.astro';
import { getCollection } from "astro:content";

const {
  title = 'Retro Gaming Verse',
  description = 'Timeless play experiences with retro games and retro-style indie games.',
  sidebar = null,
  post = null,
} = Astro.props;

/* ===== GLOBAL SEARCH DATA ===== */
const searchPosts = (await getCollection("blog")).map((p) => ({
  title: p.data.title,
  slug: p.slug,
}));
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
  </head>

  <body>
    <!-- HEADER -->
    <header class="site-header">
      <div class="header-inner">
        <div class="site-logo">
          <a href="/">Retro Gaming Verse</a>
        </div>

        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="/retro-games/">Retro Games</a>
          <a href="/retro-style-indie-games/">Retro-Style Indie Games</a>
        </nav>
      </div>
    </header>

    <!-- MAIN -->
    {sidebar ? (
      <div class="layout-with-sidebar">
        <main class="layout-content">
          <slot />
        </main>

        <aside class="layout-sidebar">
          <Sidebar variant={sidebar} post={post} />
        </aside>
      </div>
    ) : (
      <main>
        <slot />
      </main>
    )}

    <!-- FOOTER -->
    <footer class="site-footer">
      <div class="footer-inner">
        <div class="footer-about">
          <h4>Retro Gaming Verse</h4>
          <p>
            Timeless play experiences. A place to document real experiences with
            retro games and retro-inspired indie games.
          </p>
        </div>
      </div>
    </footer>

    <!-- SEARCH DATA -->
    <script type="application/json" id="global-search-data">
      {JSON.stringify(searchPosts)}
    </script>

    <!-- ðŸ”‘ SEARCH SCRIPT (ASTRO INLINE â€“ Báº®T BUá»˜C) -->
    <script is:inline>
      (function () {
        const input = document.getElementById("sidebar-search");
        if (!input) return;

        const dataEl = document.getElementById("global-search-data");
        if (!dataEl) return;

        const POSTS = JSON.parse(dataEl.textContent);

        const dropdown = document.createElement("ul");
        dropdown.className = "search-dropdown";
        dropdown.hidden = true;
        input.parentElement.appendChild(dropdown);

        input.addEventListener("input", function () {
          const q = this.value.toLowerCase().trim();

          if (q.length < 4) {
            dropdown.hidden = true;
            dropdown.innerHTML = "";
            return;
          }

          const matches = POSTS
            .filter(p => p.title.toLowerCase().includes(q))
            .slice(0, 5);

          if (!matches.length) {
            dropdown.hidden = true;
            dropdown.innerHTML = "";
            return;
          }

          dropdown.innerHTML = matches
            .map(p => `<li><a href="/${p.slug}/">${p.title}</a></li>`)
            .join("");

          dropdown.hidden = false;
        });

        document.addEventListener("click", (e) => {
          if (!e.target.closest(".sidebar-box")) {
            dropdown.hidden = true;
          }
        });
      })();
    </script>

    <style is:global>
      .search-dropdown {
        position: absolute;
        left: 0;
        right: 0;
        margin-top: 0.4rem;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        list-style: none;
        padding: 0.5rem 0;
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        z-index: 50;
      }

      .search-dropdown li {
        padding: 0.4rem 0.75rem;
      }

      .search-dropdown a {
        display: block;
        font-size: 0.9rem;
        text-decoration: none;
        color: #374151;
      }

      .search-dropdown a:hover {
        background: #f3f4f6;
      }
    </style>
  </body>
</html>
