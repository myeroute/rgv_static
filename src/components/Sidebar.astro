---
import { getCollection } from "astro:content";

const { post = null } = Astro.props;

/* ===== ALL POSTS (FOR SEARCH) ===== */
const allPosts = (await getCollection("blog")).map((p) => ({
  title: p.data.title,
  slug: p.slug,
}));

/* ===== RECENT POSTS ===== */
const recentPosts = (await getCollection("blog"))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 5);

/* ===== MORE FROM THIS TOPIC ===== */
let relatedPosts = [];

if (post && post.data) {
  const currentSlug = post.slug;

  if (post.data.game) {
    relatedPosts = (await getCollection("blog")).filter(
      (p) => p.slug !== currentSlug && p.data.game === post.data.game
    );
  } else if (post.data.tag) {
    relatedPosts = (await getCollection("blog")).filter(
      (p) => p.slug !== currentSlug && p.data.tag === post.data.tag
    );
  }

  relatedPosts = relatedPosts
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
}
---

<aside class="sidebar">

  <!-- Search -->
  <section class="sidebar-box search-box">
    <h3>Search</h3>
    <input
      type="text"
      id="sidebar-search"
      placeholder="Search posts..."
      autocomplete="off"
    />

    <ul class="search-dropdown" id="search-results" hidden></ul>
  </section>

  <!-- More from this topic -->
  {post && relatedPosts.length > 0 && (
    <section class="sidebar-box">
      <h3>More from this topic</h3>
      <ul class="sidebar-list">
        {relatedPosts.map((p) => (
          <li>
            <a href={`/${p.slug}/`}>{p.data.title}</a>
          </li>
        ))}
      </ul>
    </section>
  )}

  <!-- Recent posts -->
  <section class="sidebar-box">
    <h3>Recent Posts</h3>
    <ul class="sidebar-list">
      {recentPosts.map((p) => (
        <li>
          <a href={`/${p.slug}/`}>{p.data.title}</a>
        </li>
      ))}
    </ul>
  </section>

  <!-- About -->
  <section class="sidebar-box">
    <h3>About</h3>
    <p>
      Retro Gaming Verse is a personal journal about time spent with retro games
      and retro-style indie games, written slowly and thoughtfully.
    </p>
  </section>
</aside>

<!-- ðŸ”‘ DATA: HTML THUáº¦N -->
<script id="search-data" type="application/json">
{JSON.stringify(allPosts)}
</script>

<!-- ðŸ”‘ JS: CHáº Y á»ž BROWSER, KHÃ”NG QUA ASTRO -->
<script>
(function () {
  const input = document.getElementById("sidebar-search");
  const dropdown = document.getElementById("search-results");
  const dataEl = document.getElementById("search-data");

  if (!input || !dropdown || !dataEl) return;

  const POSTS = JSON.parse(dataEl.textContent);

  input.addEventListener("input", function () {
    const query = this.value.toLowerCase().trim();

    // ðŸ”’ chá»‰ search tá»« 4 kÃ½ tá»±
    if (query.length < 4) {
      dropdown.hidden = true;
      dropdown.innerHTML = "";
      return;
    }

    const matches = POSTS
      .filter(p => p.title.toLowerCase().includes(query))
      .slice(0, 5);

    if (matches.length === 0) {
      dropdown.hidden = true;
      dropdown.innerHTML = "";
      return;
    }

    dropdown.innerHTML = matches
      .map(p => `<li><a href="/${p.slug}/">${p.title}</a></li>`)
      .join("");

    dropdown.hidden = false;
  });

  document.addEventListener("click", function (e) {
    if (!e.target.closest(".search-box")) {
      dropdown.hidden = true;
    }
  });
})();
</script>

<style>
.sidebar {
  display: flex;
  flex-direction: column;
}

.sidebar-box {
  position: relative;
  border: 1px solid #eee;
  border-radius: 6px;
  padding: 1.5rem;
  margin-bottom: 2rem;
}

.sidebar-box input {
  width: 100%;
  padding: 0.55rem 0.6rem;
  font-size: 0.9rem;
}

/* ===== DROPDOWN ===== */
.search-dropdown {
  position: absolute;
  top: calc(100% - 0.5rem);
  left: 1.5rem;
  right: 1.5rem;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  list-style: none;
  padding: 0.5rem 0;
  margin: 0;
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  z-index: 20;
}

.search-dropdown li {
  padding: 0.4rem 0.75rem;
}

.search-dropdown a {
  display: block;
  font-size: 0.9rem;
  color: #374151;
  text-decoration: none;
}

.search-dropdown a:hover {
  background: #f3f4f6;
}
</style>
