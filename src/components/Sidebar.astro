---
import { getCollection } from "astro:content";

const { post = null } = Astro.props;

/* ===== ALL POSTS (FOR SEARCH) ===== */
const allPosts = (await getCollection("blog")).map((p) => ({
  title: p.data.title,
  slug: p.slug,
}));

/* ===== RECENT POSTS ===== */
const recentPosts = (await getCollection("blog"))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 5);

/* ===== MORE FROM THIS TOPIC ===== */
let relatedPosts = [];

if (post && post.data) {
  const currentSlug = post.slug;

  if (post.data.game) {
    relatedPosts = (await getCollection("blog")).filter(
      (p) => p.slug !== currentSlug && p.data.game === post.data.game
    );
  } else if (post.data.tag) {
    relatedPosts = (await getCollection("blog")).filter(
      (p) => p.slug !== currentSlug && p.data.tag === post.data.tag
    );
  }

  relatedPosts = relatedPosts
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
}
---

<aside class="sidebar">

  <!-- Search -->
  <section class="sidebar-box search-box">
    <h3>Search</h3>
    <input
      type="text"
      placeholder="Search posts..."
      id="sidebar-search"
      autocomplete="off"
    />

    <ul class="search-dropdown" id="search-results" hidden></ul>
  </section>

  <!-- More from this topic -->
  {post && relatedPosts.length > 0 && (
    <section class="sidebar-box">
      <h3>More from this topic</h3>
      <ul class="sidebar-list">
        {relatedPosts.map((p) => (
          <li>
            <a href={`/${p.slug}/`}>{p.data.title}</a>
          </li>
        ))}
      </ul>
    </section>
  )}

  <!-- Recent posts -->
  <section class="sidebar-box">
    <h3>Recent Posts</h3>
    <ul class="sidebar-list">
      {recentPosts.map((p) => (
        <li>
          <a href={`/${p.slug}/`}>{p.data.title}</a>
        </li>
      ))}
    </ul>
  </section>

  <!-- About -->
  <section class="sidebar-box">
    <h3>About</h3>
    <p>
      Retro Gaming Verse is a personal journal about time spent with retro games
      and retro-style indie games, written slowly and thoughtfully.
    </p>
  </section>
</aside>

<script>
  const POSTS = JSON.parse(
    document.getElementById("search-data").textContent
  );

  const input = document.getElementById("sidebar-search");
  const dropdown = document.getElementById("search-results");

  input.addEventListener("input", () => {
    const query = input.value.toLowerCase().trim();

    if (!query) {
      dropdown.hidden = true;
      dropdown.innerHTML = "";
      return;
    }

    const matches = POSTS.filter((p) =>
      p.title.toLowerCase().includes(query)
    ).slice(0, 5);

    if (matches.length === 0) {
      dropdown.hidden = true;
      dropdown.innerHTML = "";
      return;
    }

    dropdown.innerHTML = matches
      .map(
        (p) =>
          `<li><a href="/${p.slug}/">${p.title}</a></li>`
      )
      .join("");

    dropdown.hidden = false;
  });

  document.addEventListener("click", (e) => {
    if (!e.target.closest(".search-box")) {
      dropdown.hidden = true;
    }
  });
</script>

<script type="application/json" id="search-data">
  {JSON.stringify(allPosts)}
</script>

<style>
.sidebar {
  display: flex;
  flex-direction: column;
}

.sidebar-box {
  position: relative;
  border: 1px solid #eee;
  border-radius: 6px;
  padding: 1.5rem;
  margin-bottom: 2rem;
}

.sidebar-box h3 {
  margin-top: 0;
  margin-bottom: 1rem;
  font-size: 1rem;
}

.sidebar-box p {
  font-size: 0.95rem;
  color: #666;
  line-height: 1.6;
}

.sidebar-box input {
  width: 100%;
  padding: 0.55rem 0.6rem;
  font-size: 0.9rem;
}

/* ===== DROPDOWN ===== */
.search-dropdown {
  position: absolute;
  top: calc(100% - 1rem);
  left: 1.5rem;
  right: 1.5rem;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  list-style: none;
  padding: 0.5rem 0;
  margin: 0;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
  z-index: 10;
}

.search-dropdown li {
  padding: 0.4rem 0.75rem;
}

.search-dropdown a {
  text-decoration: none;
  font-size: 0.9rem;
  color: #374151;
  display: block;
}

.search-dropdown a:hover {
  background: #f3f4f6;
}

/* ===== LIST ===== */
.sidebar-list {
  list-style: none;
  padding-left: 0;
  margin: 0;
}

.sidebar-list li {
  margin-bottom: 0.6rem;
}

.sidebar-list a {
  text-decoration: none;
  color: #374151;
  font-size: 0.95rem;
}

.sidebar-list a:hover {
  color: #4f46e5;
}
</style>
