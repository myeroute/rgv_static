---
import { getCollection } from "astro:content";

const { post = null } = Astro.props;

/* ===== RECENT POSTS ===== */
const recentPosts = (await getCollection("blog"))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 5);

/* ===== MORE FROM THIS TOPIC ===== */
let relatedPosts = [];

if (post && post.data) {
  const allPosts = await getCollection("blog");
  const currentSlug = post.slug;

  if (post.data.game) {
    relatedPosts = allPosts.filter(
      (p) => p.slug !== currentSlug && p.data.game === post.data.game
    );
  } else if (post.data.tag) {
    relatedPosts = allPosts.filter(
      (p) => p.slug !== currentSlug && p.data.tag === post.data.tag
    );
  }

  relatedPosts = relatedPosts
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
}
---

<aside class="sidebar">

  <!-- Search -->
  <section class="sidebar-box">
    <h3>Search</h3>
    <input
      type="text"
      placeholder="Search posts..."
      id="sidebar-search"
    />
  </section>

  <!-- More from this topic (blog post only) -->
  {post && relatedPosts.length > 0 && (
    <section class="sidebar-box">
      <h3>More from this topic</h3>
      <ul class="sidebar-list">
        {relatedPosts.map((p) => (
          <li class="search-item">
            <a href={`/${p.slug}/`}>
              {p.data.title}
            </a>
          </li>
        ))}
      </ul>
    </section>
  )}

  <!-- Recent posts -->
  <section class="sidebar-box">
    <h3>Recent Posts</h3>
    <ul class="sidebar-list">
      {recentPosts.map((p) => (
        <li class="search-item">
          <a href={`/${p.slug}/`}>
            {p.data.title}
          </a>
        </li>
      ))}
    </ul>
  </section>

  <!-- About -->
  <section class="sidebar-box">
    <h3>About</h3>
    <p>
      Retro Gaming Verse is a personal journal about time spent with retro games
      and retro-style indie games, written slowly and thoughtfully.
    </p>
  </section>
</aside>

<script>
  const input = document.getElementById("sidebar-search");

  if (input) {
    input.addEventListener("input", () => {
      const query = input.value.toLowerCase().trim();
      const items = document.querySelectorAll(".search-item");

      items.forEach((item) => {
        const text = item.textContent.toLowerCase();
        item.style.display =
          query === "" || text.includes(query) ? "" : "none";
      });
    });
  }
</script>

<style>
.sidebar {
  display: flex;
  flex-direction: column;
}

.sidebar-box {
  border: 1px solid #eee;
  border-radius: 6px;
  padding: 1.5rem;
  margin-bottom: 2rem;
}

.sidebar-box h3 {
  margin-top: 0;
  margin-bottom: 1rem;
  font-size: 1rem;
}

.sidebar-box p {
  font-size: 0.95rem;
  color: #666;
  line-height: 1.6;
}

.sidebar-box input {
  width: 100%;
  padding: 0.55rem 0.6rem;
  font-size: 0.9rem;
}

.sidebar-list {
  list-style: none;
  padding-left: 0;
  margin: 0;
}

.sidebar-list li {
  margin-bottom: 0.6rem;
}

.sidebar-list a {
  text-decoration: none;
  color: #374151;
  font-size: 0.95rem;
}

.sidebar-list a:hover {
  color: #4f46e5;
}
</style>
