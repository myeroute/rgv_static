---
import { getCollection } from "astro:content";

const {
  variant = "home", // 'home' | 'post'
  post = null,
} = Astro.props;

/* ===== RECENT POSTS ===== */
const recentPosts = (await getCollection("blog"))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 5);

/* ===== MORE FROM THIS TOPIC (POST ONLY) ===== */
let relatedPosts = [];

if (variant === "post" && post) {
  const allPosts = await getCollection("blog");
  const currentSlug = post.slug;

  if (post.data.game) {
    relatedPosts = allPosts.filter(
      (p) =>
        p.slug !== currentSlug &&
        p.data.game === post.data.game
    );
  } else if (post.data.tag) {
    relatedPosts = allPosts.filter(
      (p) =>
        p.slug !== currentSlug &&
        p.data.tag === post.data.tag
    );
  }

  relatedPosts = relatedPosts
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
}
---

<aside class="sidebar">
  <!-- Search -->
  <section class="sidebar-box">
    <h3>Search</h3>
    <input type="text" placeholder="Search..." />
  </section>

  <!-- More from this topic (POST ONLY) -->
  {variant === "post" && relatedPosts.length > 0 && (
    <section class="sidebar-box">
      <h3>More from this topic</h3>
      <ul class="sidebar-list">
        {relatedPosts.map((p) => (
          <li>
            <a href={`/${p.slug}/`}>{p.data.title}</a>
          </li>
        ))}
      </ul>
    </section>
  )}

  <!-- Recent posts -->
  <section class="sidebar-box">
    <h3>Recent Posts</h3>
    <ul class="sidebar-list">
      {recentPosts.map((p) => (
        <li>
          <a href={`/${p.slug}/`}>{p.data.title}</a>
        </li>
      ))}
    </ul>
  </section>

  <!-- About -->
  <section class="sidebar-box">
    <h3>About</h3>
    <p>
      Retro Gaming Verse is a personal journal about time spent with retro games
      and retro-style indie games, written slowly and thoughtfully.
    </p>
  </section>
</aside>
